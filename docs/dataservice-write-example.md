# Write Example

On this page, find instructions on how to build and run the example project on different platforms and publish data to a stream layer using the HERE Open Location Platform (OLP) SDK for C++.

Before you run the example project, authorize to HERE OLP:

1. On the [Apps & keys](https://platform.here.com/admin/apps) page, copy your application access key ID and access key secret.
   For instructions on how to get the access key ID and access key secret, see the [Get Credentials](https://developer.here.com/olp/documentation/access-control/user-guide/topics/get-credentials.html) section in the Terms and Permissions User Guide.

2. In `examples/dataservice-write/example.cpp`, replace the placeholders with your access key ID, access key secret, Here Resource Name (HRN) of the catalog, and name of the layer to which you want to publish data.

   ```cpp
   const std::string kKeyId("");            // your here.access.key.id
   const std::string kKeySecret("");        // your here.access.key.secret
   const std::string gCatalogHRN("");       // the HRN of the catalog to which you to publish data
   const std::string gLayer("");            // the of the layer inside the catalog to which you want to publish data
   ```

## Build and Run on Linux

To build and run the example project on Linux:

1. Enable examples of the `CMake` targets.

   ```bash
   mkdir build && cd build
   cmake -DOLP_SDK_BUILD_EXAMPLES=ON ..
   ```

2. In the **build** folder, build the example project.

   ```bash
   cmake --build . --target dataservice-write-example
   ```

3. Execute the example project.

   ```bash
   ./examples/dataservice-write/dataservice-write-example
   ```

After building and running the example project, the following message displays automatically: "Publish Successful - TraceID: \<TraceId generated by the platform>".

## Build and Run on Android

To integrate the HERE OLP SDK for C++ libraries in the Android example project:

- [Set up prerequisites](#prerequisites-android)
- [Build the HERE OLP SDK for C++](#build-sdk-android)
- [Build and Run the APK](#build-and-run-android)

### <a name="prerequisites-android"></a>Prerequisites

Before you integrate the HERE OLP SDK for C++ libraries in the Android example project:

1. Set up the Android environment.
2. Replace the placeholders in `examples/dataservice-write/example.cpp` with your application access key ID, access key secret, catalog HRN, and layer name.
   For instructions on how to get the access key ID and access key secret, see the [Get Credentials](https://developer.here.com/olp/documentation/access-control/user-guide/topics/get-credentials.html) section in the Terms and Permissions User Guide.

### <a name="build-sdk-android"></a>Build HERE OLP SDK for C++

To build the HERE OLP SDK for C++ on Android:

1. Set `OLP_SDK_BUILD_EXAMPLES` to `ON`.
2. Specify the path to the Android NDK toolchain file using the `CMAKE_TOOLCHAIN_FILE` variable.
3. If you want to build the SDK for a specific Android platform, use the `-DANDROID_PLATFORM CMake` flag, and if you want to build the SDK for a specific Android architecture, use the `-DANDROID_ABI` flag.
   For more details, see [NDK-specific CMake variables](https://developer.android.com/ndk/guides/cmake#variables).

   ```bash
   mkdir build && cd build
   cmake .. -DOLP_SDK_BUILD_EXAMPLES=ON -DCMAKE_TOOLCHAIN_FILE=$NDK_ROOT/build/cmake/android.toolchain.cmake -DANDROID_ABI=arm64-v8a
   ```

   The `CMake` command generates a `Gradle` project in the `build/examples/dataservice-write/android` folder.

4. Install the HERE OLP SDK for C++ libraries into the **sysroot** directory.

   ```bash
   # If necessary, execute as sudo.
   (sudo) make install
   ```

### <a name="build-and-run-android"></a>Build and Run the APK

To build and run the APK:

1. In the Android Studio IDE, open the `build/examples/dataservice-write/android/build.gradle` script.
2. Provide your application access key ID, access key secret, catalog HRN, and layer name.
3. Install and run the `dataservice_write_example` APK.

The main screen displays the following message: "Publish Successful".

## Build and run on iOS

To integrate the HERE OLP SDK for C++ libraries in the iOS example application written in the Objective-C language:

- [Set up prerequisites](#prerequisites-ios)
- [Build the HERE OLP SDK for C++](#build-sdk-ios)
- [Build and Run the Application](#build-and-run-ios)

### <a name="prerequisites-ios"></a>Prerequisites

Before you integrate the HERE OLP SDK for C++ libraries in the iOS example project:

1. To set up the iOS development environment, install the `XCode` and command-line tools.
2. Install external dependencies.
   For information on dependencies and installation instructions, see the [related section](https://github.com/heremaps/here-olp-sdk-cpp#dependencies) in the README.md file.
3. Replace the placeholders in `examples/dataservice-write/example.cpp` with your application access key ID, access key secret, catalog HRN, and layer name.
   For instructions on how to get the access key ID and access key secret, see the [Get Credentials](https://developer.here.com/olp/documentation/access-control/user-guide/topics/get-credentials.html) section in the Terms and Permissions User Guide.

```bash
mkdir build && cd build
cmake .. -GXcode  -DCMAKE_TOOLCHAIN_FILE=../cmake/toolchains/iOS.cmake -DPLATFORM=iphoneos -DOLP_SDK_BUILD_EXAMPLES=ON -DOLP_SDK_ENABLE_TESTING=OFF
```

To configure the HERE OLP SDK for C++ for a simulator, set the `SIMULATOR` variable to `ON`.

### <a name="build-sdk-ios"></a>Build the HERE OLP SDK for C++

To build the HERE OLP SDK for C++ on iOS:

1. Set `OLP_SDK_BUILD_EXAMPLES` to `ON`.
2. (Optional) To disable tests, set `OLP_SDK_ENABLE_TESTING` to `OFF`.
3. Specify the path to the iOS toolchain file using the `CMAKE_TOOLCHAIN_FILE` variable.
   > **Note:** The iOS toolchain file is shipped together with the SDK and located under the `<olp-sdk-root>/cmake/toolchains/iOS.cmake`.

```bash
mkdir build && cd build
cmake .. -GXcode  -DCMAKE_TOOLCHAIN_FILE=../cmake/toolchains/iOS.cmake -DPLATFORM=iphoneos -DOLP_SDK_BUILD_EXAMPLES=ON -DOLP_SDK_ENABLE_TESTING=OFF
```

### <a name="build-and-run-ios"></a>Build and Run the Application

To build an run the example application on iOS:

1. Open the generated `XCode` project.

   ```bash
   open olp-cpp-sdk.xcodeproj
   ```

2. In the `XCode` project, from the list of schemes, select the `dataservice-write-example` scheme.

3. In the `dataservice-write-example` target, specify your application access key ID and access key secret.

4. Build and run the example application.

The main UI screen displays the following message: "Publish Successful". For more details, check the device logs.

If you encounter an error message, for a detailed error description, check the device logs. Example of an error message: "Publish Failed".

## How it works

### <a name="authenticate-to-here-olp-using-client-credentials"></a>Authenticate to HERE OLP Using Client Credentials

To authenticate with the Open Location Platform (OLP), you must get platform credentials that contain the access key ID and access key secret.

To authenticate using client credentials:

1. Get your platform credentials. For instructions, see the [Get Credentials](https://developer.here.com/olp/documentation/access-control/user-guide/topics/get-credentials.html) section in the Terms and Permissions User Guide.

   You get the `credentials.properties` file.

2. Initialize the authentification settings using the **here.access.key.Ñ–d** and **here.access.key.secret** from the `credentials.properties` file as `kKeyId` and `kKeySecret` respectively.

   ```cpp
   olp::authentication::Settings settings({kKeyId, kKeySecret});
   settings.task_scheduler = task_scheduler;
   settings.network_request_handler = http_client;
   ```

3. To get the OAuth 2.0 token from OLP, set up the `AuthenticationSettings` object with a default token provider.

   ```cpp
   olp::client::AuthenticationSettings auth_settings;
   auth_settings.provider =
     olp::authentication::TokenProviderDefault(std::move(settings));
   ```

You can use the `TokenProvider` object to create the `OlpClientSettings` object. For more information, see [Create OlpClientSettings](#create-olpclientsettings).

### <a name="create-olpclientsettings"></a>Create `OlpClientSettings`

You need to create the `OlpClientSettings` object to get catalog and partition metadata and retrieve versioned and volatile layer data from OLP.

To create the `OlpClientSettings` object:

1. To perform requests asynchronously, create the `TaskScheduler` object.

   ```cpp
   std::shared_ptr<olp::thread::TaskScheduler> task_scheduler =
         olp::client::OlpClientSettingsFactory::CreateDefaultTaskScheduler(1u);
   ```

2. To internally operate with the OLP services, create the `Network` client.

   ```cpp
   std::shared_ptr<olp::http::Network> http_client = olp::client::
        OlpClientSettingsFactory::CreateDefaultNetworkRequestHandler();
   ```

   > **Note:** The `Network` client is designed and intended to be shared.

3. [Authenticate](#authenticate-to-here-olp-using-client-credentials) to OLP.

4. Set up the `OlpClientSettings` object.

   ```cpp
   olp::client::OlpClientSettings client_settings;
   client_settings.authentication_settings = auth_settings;
   client_settings.task_scheduler = std::move(task_scheduler);
   client_settings.network_request_handler = std::move(http_client);
   client_settings.cache =
       olp::client::OlpClientSettingsFactory::CreateDefaultCache({});
   ```

The `OlpClientSettings` class pulls together all the settings for customization of the client library behavior:

- `retry_settings` &ndash; sets `olp::client::RetrySettings` to use.
- `proxy_settings` &ndash; sets `olp::authentication::NetworkProxySettings` to use.
- `authentication_settings` &ndash; sets `olp::client::AuthenticationSettings` to use.
- `network_request_handler` &ndash; sets the handler for asynchronous execution of network requests.

### Publish Data to a Stream Layer

You can create a queue that streams data to data consumers in real time using a [stream layer](https://developer.here.com/olp/documentation/data-user-guide/portal/layers/layers.html#stream-layers).

To publish data to the stream layer:

1. Get an access key ID and access key secret. For instructions, see [Authenticate to HERE OLP Using Client Credentials](#authenticate-to-here-olp-using-client-credentials).

2. Create the `OlpClientSettings` object. For instructions, see [Create OLP Client Settings](#create-olpclientsettings).

3. Create the `StreamLayerClientSettings` object.

   ```cpp
   auto stream_client_settings = olp::dataservice::write::StreamLayerClientSettings{};
   ```

4. Create the `StreamLayerClient` object with the HRN of the catalog that contains the layer, the stream layer client settings from step 3, and the OLP client settings from step 2.

   ```cpp
   auto client = olp::dataservice::write::StreamLayerClient(
   olp::client::HRN{kCatalogHRN}, stream_client_settings, client_settings);
   ```

5. Create the `PublishDataRequest` object with the data that you want to publish and layer ID.

   ```cpp
   auto request = PublishDataRequest().WithData(buffer).WithLayerId(kLayer);
   ```

6. Call the `PublishData` method with the `DataRequest` parameter.

   ```cpp
   auto futureResponse = client.PublishData(request);
   ```

7. Wait for the `PublishDataResponse` future.

   ```cpp
   auto response = futureResponse.GetFuture().get();
   ```

The `PublishDataResponse` object holds details of the completed operation and is used to determine operation success and access resultant data:

- `IsSuccessful()` &ndash; if the operation is successful, returns `true`. Otherwise, returns `false`.
- `GetResult()`&ndash; if the operation is successful, returns the following resultant data: `olp::dataservice::write::PublishDataResult`. The `PublishDataResult` class contains the `GetTraceID` method that returns the trace ID of the request.
- `GetError()` &ndash; contains error information as a result of an error in the `olp::client::ApiError` object.

```cpp
if (response.IsSuccessful()) {
    auto response_result = response.GetResult();
    // Handle success
} else {
    auto api_error = response.GetError();
    // Handle fail
}
```
