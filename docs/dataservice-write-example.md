# Write example

This example shows how to write your own data to the OLP stream layer, using the HERE OLP Edge SDK C++.

Before you run the example, authorize by replacing the placeholders in `examples/dataservice-write/example.cpp` with your app access key id, secret access key, catalog HRN (Here Resource Name) and layer, which you can find on the platform `Apps & keys` page:

```cpp
const std::string kKeyId("");            // your here.access.key.id
const std::string kKeySecret("");        // your here.access.key.secret
const std::string gCatalogHRN("");       // your catalog HRN where to write to
const std::string gLayer("");            // layer name inside catalog to use
```

## Building and running on Linux

Configure the project with `EDGE_SDK_BUILD_EXAMPLES` set to `ON` to enable examples `CMake` targets:

```bash
mkdir build && cd build
cmake -DEDGE_SDK_BUILD_EXAMPLES=ON ..
```

To build the example, run the following command in the `build` folder:

```bash
cmake --build . --target dataservice-write-example
```

To execute the example, run:

```bash
./examples/dataservice-write/dataservice-write-example
```

After building and running the example, a `Publish Successful - TraceID: <TraceId generated by the platform>` message displays automatically.

## Building and running on Android

This example shows how to integrate and use the HERE OLP Edge SDK C++ for an Android project.

### Prerequisites

* Set up the Android environment.
* Replace the placeholders in `examples/dataservice-write/example.cpp` with your app access key id, secret access key, catalog HRN and layer.

### Build HERE OLP Edge SDK C++

Before you build the example, complete the following:

* Configure the SDK with `EDGE_SDK_BUILD_EXAMPLES` set to `ON`.
* Specify the path to Android NDK's toolchain file set via the `CMAKE_TOOLCHAIN_FILE` variable.
* In case you want to build Edge SDK for a specific Android platform, use `-DANDROID_PLATFORM CMake` flag, and `-DANDROID_ABI`, if you want to build for specific Android architecture. For more details, see [NDK-specific CMake variables](https://developer.android.com/ndk/guides/cmake#variables).

```bash
mkdir build && cd build
cmake .. -DEDGE_SDK_BUILD_EXAMPLES=ON -DCMAKE_TOOLCHAIN_FILE=$NDK_ROOT/build/cmake/android.toolchain.cmake -DANDROID_ABI=arm64-v8a
```

The `CMake` command generates a `Gradle` project in the `build/examples/dataservice-write/android` folder. Before using the project, install HERE OLP Edge SDK C++ libraries into the sysroot directory:

```bash
# Execute as sudo if necessary
(sudo) make install
```

### Assemble APK and run it on Android device

After you complete the `Gradle` project configuration, you can use `gradlew` executable to build and install APK on your Android device:

```bash
cd examples/dataservice-write/android
./gradlew assembleDebug
./gradlew installDebug
```

Alternatively, you can use Android Studio IDE by opening the `build/examples/dataservice-write/android/build.gradle` script.

After you provide your app access key id, secret access key, catalog, and layer information, install and run `dataservice_write_example` APK, the main UI screen displays a message `Publish Successful`. If you encounter an error, please check the device's logcat for the error message.

> **Note:** you can run `CMake` command directly from the `<olp-edge-sdk-root>/examples/dataservice-write/` folder if you have already built and installed HERE OLP Edge SDK C++ libraries for Android. Make sure you provide correct path to the `LevelDB` library, and correct `EDGE_SDK_NETWORK_PROTOCOL_JAR` parameter in the `CMake` command, invoked by the `build/examples/dataservice-write/android/app/build.gradle` script.

## Building and running on iOS

This example shows how to integrate and use the HERE OLP Edge SDK C++ for a basic iOS application,written in Objective-C language.

### Prerequisites

* Set up the iOS development environment > install the `XCode` and command-line tools.
* Install external dependencies > refer to the `README.md` file, located under the `<olp-edge-sdk-root>/README.md`.
* Replace the placeholders in `examples/dataservice-write/example.cpp` with your app access key id, secret access key, catalog HRN and layer.

### Build HERE OLP Edge SDK C++

Before building the example, complete the following:

* Configure the HERE OLP Edge SDK C++ with `EDGE_SDK_BUILD_EXAMPLES` set to `ON`.
* Optionally, disable tests with `EDGE_SDK_ENABLE_TESTING` set to `OFF`.
* Specify the path to the iOS toolchain file shipped together with the SDK, which is located under the `<olp-edge-sdk-root>/cmake/toolchains/iOS.cmake`:

```bash
mkdir build && cd build
cmake .. -GXcode  -DCMAKE_TOOLCHAIN_FILE=../cmake/toolchains/iOS.cmake -DPLATFORM=iphoneos -DEDGE_SDK_BUILD_EXAMPLES=ON -DEDGE_SDK_ENABLE_TESTING=OFF
```

> **Note:** to configure the HERE OLP Edge SDK C++ for a simulator, set the `SIMULATOR` variable to `ON`.

### Build and run the application on the device

Now open the generated `XCode` project:
```bash
open olp-cpp-sdk.xcodeproj
```

Select the `dataservice-write-example` from the schemes list in the `XCode` project and specify your authorization credentials for the `dataservice-write-example` target.

Once everything is set up correctly, build and run the example application on your device. After building and running of example is complete, you see the `Publish Successful` message in the main UI screen. If you encounter an error message, e.g. `Publish Failed`, please check the device's logs for the detailed description of the error.

## How it works

### StreamLayerClient

The `StreamLayerClient` class provides an interface for ingestion of the OLP data and defines the following operations:

* `PublishData`: Publish data into the OLP stream layer.
* `PublishSdii`: Publish list of SDII messages into the OLP stream layer.

To create a `StreamLayerClient`, provide the corresponding HRN and preconfigured `OlpClientSettings`:

```cpp
// Setup AuthenticationSettings with a default token provider that will
// retrieve an OAuth 2.0 token from OLP.
olp::client::AuthenticationSettings authSettings;
authSettings.provider =
    olp::authentication::TokenProviderDefault(kKeyId, kKeySecret);

// Setup OlpClientSettings and provide it to the StreamLayerClient.
olp::client::OlpClientSettings clientSettings;
clientSettings.authentication_settings = authSettings;

auto client = std::make_shared<StreamLayerClient>(
    olp::client::HRN{gCatalogHRN}, clientSettings);
```

The `StreamLayerClient` class pulls together all the different settings for customization of the client library behavior.

* `retry_settings`: Sets the `olp::client::RetrySettings` to use.
* `proxy_settings`: Sets the `olp::authentication::NetworkProxySettings` to use.
* `authentication_settings`: Sets the `olp::client::AuthenticationSettings` to use.
* `network_async_handler`: Sets the handler for asynchronous execution of network requests.

Configuration of the `authentication_settings` is sufficient to start using the `CatalogClient`.

### Publish data into stream layer

Create the `PublishDataRequest` to publish data into the stream layer. The `PublishDataRequest` class specifies the parameters of the `PublishData` function, including the following:

* `WithData`: Specify the data for upload to the layer.
* `WithLayerId`: Specify the stream layer to upload data to.
* `WithTraceId`: Set the trace id for the request.
* `WithBillingTag`: Set the billing tag for the request.
* `WithChecksum`: Set the checksum for the partition.

```cpp
// Create a publish data request
auto request = PublishDataRequest().WithData(buffer).WithLayerId(gLayer);
```

Then pass it to the `StreamLayerClient` via `PublishData` method:

```cpp
// Write data to OLP Stream Layer using StreamLayerClient
auto futureResponse = client->PublishData(request);
```

The execution result is a `CancellableFuture` that contains `PublishDataResponse` object. The `PublishDataResponse` class holds the details of a completed operation, and is used to determine operation success and access resultant data.

* `IsSuccessful`: Returns true in case of a successful response, false otherwise.
* `GetResult`: Returns the resultant data (`olp::dataservice::write::PublishDataResult`) in case of a successful operation.
* `GetError`: Contains the error information as a result of an error in the `olp::client::ApiError` object.

The `PublishDataResult` class returns details of the request result, including:

* `GetTraceID`: Get the trace id of the request.

```cpp
// Wait for response
auto response = futureResponse.GetFuture().get();

// Check the response
if (!response.IsSuccessful()) {
    EDGE_SDK_LOG_INFO_F("write-example",
                        "Error writing data - HTTP Status: %d Message: %s",
                        response.GetError().GetHttpStatusCode(),
                        response.GetError().GetMessage().c_str());
    return -1;
} else {
    EDGE_SDK_LOG_ERROR_F("write-example", "Publish Successful - TraceID: %s",
                         response.GetResult().GetTraceID().c_str());
}
```
