# ============================================================
# CI Pipeline - Refactored
# Features added:
# - Matrix builds (reduce duplication)
# - Concurrency control
# - Dependency + ccache caching
# - Artifact uploads
# - Better permissions
# - Cleaner structure
# - Improved logging and comments
# ============================================================

name: CI

# ------------------------------------------------------------
# Workflow triggers
# ------------------------------------------------------------
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ "*" ]

# ------------------------------------------------------------
# Prevent duplicate builds on same branch
# Cancels previous running jobs when new commit pushed
# ------------------------------------------------------------
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# ------------------------------------------------------------
# Global environment variables
# ------------------------------------------------------------
env:
  SEGFAULT_SIGNALS: all
  BUILD_TYPE: RelWithDebInfo

# ------------------------------------------------------------
# Minimal permissions (security best practice)
# ------------------------------------------------------------
permissions:
  contents: read

jobs:

  # ==========================================================
  # C++ LINT CHECK
  # ==========================================================
  cpplint:
    name: Cpplint
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Run project lint script
      - name: Run C++ lint checker
        run: ./scripts/misc/cpplint_ci.sh


  # ==========================================================
  # LINUX BUILD + TEST (Matrix Based)
  # Reduces repeated jobs for multiple compilers
  # ==========================================================
  linux-build-test:
    name: Linux Build (${{ matrix.compiler }} / cache=${{ matrix.cache }})
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-9, gcc-11, gcc-13]
        cache: [ON, OFF]

    env:
      CC: ${{ matrix.compiler }}
      CXX: ${{ matrix.compiler == 'gcc-9' && 'g++-9' || matrix.compiler == 'gcc-11' && 'g++-11' || 'g++-13' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # Cache ccache for faster rebuilds
      # ------------------------------------------------------
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ matrix.compiler }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.compiler }}-

      # ------------------------------------------------------
      # Install dependencies
      # ------------------------------------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libboost-all-dev \
            libssl-dev \
            libcurl4-openssl-dev \
            ccache \
            ${{ matrix.compiler }} \
            g++-${{ matrix.compiler##*- }} \
            --no-install-recommends

      # ------------------------------------------------------
      # Compile project
      # ------------------------------------------------------
      - name: Build project
        run: |
          gcc --version
          if [ "${{ matrix.cache }}" = "OFF" ]; then
            ./scripts/linux/psv/build_psv_no_cache.sh
          else
            ./scripts/linux/psv/build_psv.sh
          fi

      # ------------------------------------------------------
      # Run tests (only when cache enabled)
      # ------------------------------------------------------
      - name: Run unit and integration tests
        if: matrix.cache == 'ON'
        run: ./scripts/linux/psv/test_psv.sh

      # ------------------------------------------------------
      # Upload logs if build fails
      # ------------------------------------------------------
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.compiler }}
          path: build/


  # ==========================================================
  # COVERAGE + CODECOV
  # ==========================================================
  coverage:
    name: Coverage + Codecov
    runs-on: ubuntu-22.04
    env:
      BUILD_TYPE: COVERAGE
      CC: gcc-9
      CXX: g++-9

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libboost-all-dev \
            ccache \
            libssl-dev \
            libcurl4-openssl-dev \
            gcc-9 g++-9 \
            --no-install-recommends

      - name: Build project
        run: ./scripts/linux/psv/build_psv.sh

      - name: Run tests
        run: ./scripts/linux/psv/test_psv.sh

      # Upload coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: true
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}


  # ==========================================================
  # CLANG BUILD
  # ==========================================================
  clang-build:
    name: Clang Build
    runs-on: ubuntu-22.04

    env:
      CC: clang-11
      CXX: clang++-11
      CXXFLAGS: -Wno-deprecated-copy

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-11 ccache libcurl4-openssl-dev

      - name: Build project
        run: scripts/linux/psv/build_psv.sh

      - name: Run tests
        run: scripts/linux/psv/test_psv.sh


  # ==========================================================
  # WINDOWS BUILD
  # ==========================================================
  windows-build:
    name: Windows Build (VS2022)
    runs-on: windows-2022
    env:
      GENERATOR: "Visual Studio 17 2022"

    steps:
      - uses: actions/checkout@v4

      - name: Build
        shell: bash
        run: scripts/windows/build.sh


  # ==========================================================
  # ANDROID BUILD
  # ==========================================================
  android-build:
    name: Android Build
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Verify Android SDK
        run: env && ls -la $ANDROID_HOME

      - name: Android build
        run: scripts/android/build.sh


  # ==========================================================
  # COMMIT MESSAGE CHECKER
  # ==========================================================
  commit-check:
    name: Commit Checker
    runs-on: ubuntu-22.04
    if: github.ref_name != 'master'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify commit text
        run: scripts/misc/commit_checker.sh


  # ==========================================================
  # CODE FORMATTING CHECK
  # ==========================================================
  formatting-check:
    name: Clang Format Check
    runs-on: ubuntu-22.04

    env:
      CLANG_FORMAT_FILE: clang-format.diff

    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run formatting checker
        run: ./scripts/misc/clang_format_ci.sh

      - name: Upload formatting diff
        uses: actions/upload-artifact@v4
        with:
          name: clang-format-diff
          path: ${{ env.CLANG_FORMAT_FILE }}

      - name: Fail if formatting issues exist
        run: |
          if [ -s ${CLANG_FORMAT_FILE} ]; then
            echo "Unformatted files detected"
            exit 1
          fi
